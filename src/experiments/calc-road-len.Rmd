---
title: "Pedalling Forward: The Evolution of Dedicated Cycling Infrastructure in Canadian Cities from 2010 to 2022"
subtitle: "Calculating Road Lengths By Infrastructure Type"
author:
- "Richard Wen <richard.wen@utoronto.ca>"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
    pdf_document:
        toc: true
        toc_depth: 3
        highlight: zenburn
---

# Libraries

```{r}
library(tidyverse)
library(glue)
library(readxl)
```

# Helper Function

The following function calculates yearly road lengths by infrastructure type using cumulative sums and filling in missing years and types.

For a given infrastructure type, the total road length for a given year is expressed below:

$$
length_{year,type} = f(year,type) = \sum_{i=year_{min}}^{year}l_{i, type} \mid l \geq 0
$$

Where:

* $year$ is the given year
* $type$ is the infrastructure type
* $year_{min}$ is the earliest year available in the data
* $l_{i,type}$ is the road length $l$ for previous years $i$ and infrastructure $j$
* $l_{i,type}$ is set to 0 if there is no data

```{r}

#' Calculate Yearly Road Lengths By Infrastructure Type
#'
#' @param df A data.frame with three columns containing the year, type, and road lengths.
#' @param year_col The name (char) or index (int) of the column containing the years.
#' @param type_col The name (char) or index (int) of the column containing the infrastructure type
#' @param len_col The name (char) or index (int) of the column containing the road lengths.
#' @param out_col The name (char) of the column containing the calculated yearly road lengths by type.
#'
#' @return A data.frame with three columns containing the year, type, and calculated yearly road lengths by type.
#' @export
#'
calc_yearly_len <- function(
		df,
		year_col = 1,
		type_col = 2,
		len_col = 3,
		out_col = "len"
	) {
	
	# Convert data types
	df[[year_col]] <- as.integer(df[[year_col]])
	df[[type_col]] <- as.character(df[[type_col]])
	df[[len_col]] <- as.numeric(df[[len_col]])
	
	# Remove rows with empty type
	out <- df %>% filter(
		!is.na(.data[[type_col]])
	)
	
	# Add dummy len for each type and year combo
	# Covers cases where type and year combo does not exist
	# E.g. No new PL installs in 2021, hence a record PL in 2021 does not exist
	type_uniq <- unique(out[[type_col]])
	type_n <- length(type_uniq)
	year_uniq <- min(out[[year_col]], na.rm = TRUE):max(out[[year_col]], na.rm = TRUE)
	year_n <- length(year_uniq)
	out <- out %>% add_row(
		!!year_col := rep(year_uniq, each = type_n),
		!!type_col := rep(type_uniq, year_n),
		!!len_col := rep(0, type_n * year_n)
	)
	
	# Calc cumsum for each non-empty type ordered by year
	out <- out %>%
		arrange(.data[[year_col]]) %>%
		group_by(.data[[type_col]]) %>%
		mutate(
			!!out_col := cumsum(segment_km)
		)

	# Get the last cumsum for each year and type
	out <- out %>%
		group_by(.data[[year_col]], .data[[type_col]]) %>%
		arrange(desc(row_number())) %>%
		slice(1)
	
	# Return only the columns spec
	out <- out %>% select(c(
			year_col,
			type_col,
			out_col
		))
	return(out)
}
```

# Example Calculations with Vancouver Data

Calculate road lengths per year adjusted for up to 2 changes, assuming data contains lengths in meters.

## Data

Read road segment data along with install and upgrade variables.

```{r}
vanc_raw <- read_excel("../../data/raw/vancouver/Vancouver_Bikeways_Complete_AS.xlsm")
vanc_raw
```

## Preprocessing

Clean the raw data.

```{r}

# Preprocess
vanc <- vanc_raw %>%
	rename(
		install_year = "INST_YR",
		install_type = "INST_MIN_TYPE",
		upgrade1_year = "UPGR1_YR",
		upgrade1_type = "UPGR1_MIN_TYPE",
		upgrade2_year = "UPGR2_YR",
		upgrade2_type = "UPGR2_MIN_TYPE",
		segment_km = "segment_l0"
	) %>%
	mutate( # data types
		install_year = as.integer(install_year),
		install_type = as.character(install_type),
		upgrade1_year = as.integer(upgrade1_year),
		upgrade1_type = as.character(upgrade1_type),
		upgrade2_year = as.integer(upgrade2_year),
		upgrade2_type = as.character(upgrade2_type),
		segment_km = as.numeric(segment_km)
	) %>%
	mutate_at( # Set values to NA for types
		c("install_type", "upgrade1_type", "upgrade2_type"),
		~replace(., . %in% c("None", "", "N"), NA)
	) %>%
	mutate_at( # Set 0 or invalid years to NA
		c("install_year", "upgrade1_year", "upgrade2_year"),
		~replace(., . <= 0, NA)
	) %>%
	mutate( # convert lens from meters to km
		segment_km = segment_km / 1000
	) %>%
	filter( # Remove invalid install year records
		!is.na(install_year)
	)

# Preview
vanc %>% select(
	install_year,
	install_type,
	upgrade1_year,
	upgrade1_type,
	upgrade2_year,
	upgrade2_type,
	segment_km
)
```

## Step 1: Calculate Install Road Lengths By Infrastructure Type

Calculate cumulative sum of road lengths with installations by infrastructure type ordered by year.

$$
length_{year,type}^{install}
$$

```{r}
vanc_install <- calc_yearly_len(
	vanc,
	year_col = "install_year",
	type_col = "install_type",
	len_col = "segment_km",
	out_col = "install_len"
) %>% rename(
	year = "install_year",
	type = "install_type"
)
vanc_install
```

## Step 2a: Calculate Yearly Road Lengths By Infrastructure Type for Change 1

These road lengths are to be added for the particular years and infrastructure types.

$$
length_{year,type}^{upgrade1}
$$

```{r}
vanc_upgrade1 <- calc_yearly_len(
	vanc %>% filter( # existing Change 1 with diff type upgrade
		!is.na(upgrade1_year) & install_type != upgrade1_type
	),
	year_col = "upgrade1_year",
	type_col = "upgrade1_type",
	len_col = "segment_km",
	out_col = "upgrade1_len"
) %>% rename(
	year = "upgrade1_year",
	type = "upgrade1_type"
)
vanc_upgrade1
```

## Step 2b: Calculate Yearly Road Lengths for Replaced Infrastructure Types from Change 1

These road lengths are to be subtracted for the particular years and infrastructure types.

$$
length_{year,type}^{replacement1}
$$

```{r}
vanc_upgrade1_repl <- calc_yearly_len(
	vanc %>% filter( # existing upgrade 1 with diff type upgrade
		!is.na(upgrade1_year) & install_type != upgrade1_type
	),
	year_col = "upgrade1_year",
	type_col = "install_type",
	len_col = "segment_km",
	out_col = "upgrade1_repl_len"
) %>% rename(
	year = "upgrade1_year",
	type = "install_type"
)
vanc_upgrade1_repl
```

## Step 3a: Calculate Yearly Road Lengths By Infrastructure Type for Change 2

These road lengths are to be added for the particular years and infrastructure types.

$$
length_{year,type}^{upgrade2}
$$

```{r}
vanc_upgrade2 <- calc_yearly_len(
	vanc %>% filter( # existing upgrade 1 with diff type upgrade
		!is.na(upgrade2_year) & install_type != upgrade2_type
	),
	year_col = "upgrade2_year",
	type_col = "upgrade2_type",
	len_col = "segment_km",
	out_col = "upgrade2_len"
) %>% rename(
	year = "upgrade2_year",
	type = "upgrade2_type"
)
vanc_upgrade2
```

## Step 3b: Calculate Yearly Road Lengths for Replaced Infrastructure Types from Change 2

These road lengths are to be subtracted for the particular years and infrastructure types.

$$
length_{year,type}^{replacement2}
$$

```{r}
vanc_upgrade2_repl <- calc_yearly_len(
	vanc %>% filter( # existing upgrade 1 with diff type upgrade
		!is.na(upgrade2_year) & install_type != upgrade2_type
	),
	year_col = "upgrade2_year",
	type_col = "upgrade1_type",
	len_col = "segment_km",
	out_col = "upgrade2_repl_len"
) %>% rename(
	year = "upgrade2_year",
	type = "upgrade1_type"
)
vanc_upgrade2_repl
```

## Step 4: Calculate Final Yearly Road Lengths by Infrastructure Type

Join all year road lengths by year and type across installs and upgrades.

Then add road lengths for install and upgrades, and subtract road lengths for replacements from upgrades.

$$
length_{year,type}^{install} + length_{year,type}^{upgrade1} + length_{year,type}^{upgrade2} - length_{year,type}^{replacement1} - length_{year,type}^{replacement2}
$$

```{r}
vanc_yearly_len <- list(
		vanc_install,
		vanc_upgrade1, 
		vanc_upgrade1_repl,
		vanc_upgrade2,
		vanc_upgrade2_repl
	) %>%
	reduce(
		left_join, by = c("year", "type")
	) %>%
	ungroup() %>%
	mutate(
		across(everything(), ~replace_na(., 0))
	) %>%
	mutate(
		len = install_len + upgrade1_len + upgrade2_len - upgrade1_repl_len - upgrade2_repl_len
	)
vanc_yearly_len
```

# Final Function

$$
length_{year,type}^{install} + length_{year,type}^{upgrade1} + length_{year,type}^{upgrade2} - length_{year,type}^{replacement1} - length_{year,type}^{replacement2}
$$

```{r}
calc_yearly_adj_len <- function(
		df,
		year_cols = c("install_year", "upgrade1_year", "upgrade2_year"),
		type_cols = c("install_type", "upgrade1_type", "upgrade2_type"),
		len_cols = "segment_km",
		out_cols = c("install_len", "upgrade1_len", "upgrade2_len"),
		out_col = "adj_len",
		repl_suffix = "_replaced"
	) {
	
	# Convert len_col if char
	len_cols <- rep(len_cols, length(year_cols))
	
	# Check cols same size
	year_cols_n <- length(year_cols)
	type_cols_n <- length(type_cols)
	len_cols_n <- length(len_cols)
	out_cols_n <- length(out_cols)
	if (length(unique(c(year_cols_n, type_cols_n, len_cols_n, out_cols_n))) != 1) {
		stop(glue(
			"The arguments 'year_cols' ({year_cols_n}), 'type_cols' ({type_cols_n}), 'len_cols' ({len_cols_n}), and 'out_cols' ({out_cols_n}) must be the same length."
		))
	}
	
	# Calc yearly lens by infra type per install or change
	out <- list()
	for (i in 1:length(year_cols)) {
		
		# Get year, type, and len cols
		ycol <- year_cols[[i]]
		tcol <- type_cols[[i]]
		lcol <- len_cols[[i]]
		ocol <- out_cols[[i]]
		
		# Calc yearly len for install or change
		out <- append(
			out,
			calc_yearly_len(
				df,
				year_col = ycol,
				type_col = tcol,
				len_col = lcol,
				out_col = ocol
			) %>%
				rename(
					"year" := !!ycol,
					"type" := !!tcol
				) %>% list
		)
		
		# Calc yearly len for replacement
		if (i > 1) {
			tcol_repl <- type_cols[[i - 1]]
			lcol_repl <- len_cols[[i - 1]]
			out <- append(
				out,
				calc_yearly_len(
					df %>% filter(.data[[tcol]] != .data[[tcol_repl]]),
					year_col = ycol,
					type_col = tcol_repl,
					len_col = lcol_repl,
					out_col = glue("{ocol}{repl_suffix}")
				) %>%
				rename(
					"year" := !!ycol,
					"type" := !!tcol_repl
				) %>% list
			)
		}
	}
	
	# Calc yearly adj lens by infra type
	out <- out %>%
		reduce(
			left_join, by = c("year", "type")
		) %>%
		ungroup() %>%
		mutate( # set unjoined na values to 0
			across(everything(), ~replace_na(., 0))
		) %>%
		mutate( # added len by infra types due to install or changes
			!!out_col := reduce(across(all_of(out_cols)), `+`)
		) %>%
		mutate( # removed len by infra types due to replacements
			!!out_col := .data[[out_col]] - reduce(across(all_of(paste0(out_cols[2:out_cols_n], repl_suffix))), `-`)
		)
	return(out)
}
```

## Test Final Function

```{r}
calc_yearly_adj_len(vanc)
```